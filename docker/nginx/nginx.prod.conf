upstream user-service {
    server localhost:4000;
}

upstream question-service {
    server localhost:4010;
}

upstream docs {
    server localhost:3000;
}

server
{
        listen 80;

        location /
        {
                root /usr/share/nginx/html;
                index index.html index.htm;
                try_files $uri $uri/ /index.html;

                location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$
                {
                        expires 1y;
                        add_header Cache-Control "public, immutable";
                }

                location ~* \.html$
                {
                        expires -1;
                        add_header Cache-Control "no-cache, no-store, must-revalidate";
                }
        }

        location /api/user/
        {
                proxy_pass http://user-service/;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection 'upgrade';
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_cache_bypass $http_upgrade;
        }

        location /api/question/
        {
                proxy_pass http://question-service/;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection 'upgrade';
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_cache_bypass $http_upgrade;
        }
}

server
{
        listen 3005;

        location /
        {
                auth_basic "Restricted Area";
                auth_basic_user_file /etc/nginx/.htpasswd;
                proxy_pass http://docs/;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
        }
}
