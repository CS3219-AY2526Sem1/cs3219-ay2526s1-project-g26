version: '3.9'
name: peerprep-dev

services:
  nginx:
    image: nginx:stable-alpine
    container_name: nginx-dev
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.dev.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - frontend
      - user-service
      - question-service

  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile.dev
    container_name: frontend
    ports:
      - "3000:3000"
    volumes:
      - ../frontend:/app
      - /app/node_modules
    environment:
      - REACT_APP_API_BASE_URL=http://localhost/api
    stdin_open: true
    tty: true

  docs:
    build:
      context: ../docs
      dockerfile: Dockerfile
    container_name: docs
    ports:
      - "3005:3000"
    volumes:
      - ../docs:/app

  # User Service
  user-service:
    build:
      context: ../services/userService
      dockerfile: Dockerfile.dev
    container_name: user-service
    volumes:
      - ../services/userService:/app
      - /app/node_modules
    environment:
      - PORT=4000
      - DATABASE_URL=postgresql://postgres:postgres@user-service-db:5432/users_db
      - JWT_SECRET=4fa01f2f08d88986b2cc1e0c3d35ae63
      - JWT_EXPIRES_IN=14d
    depends_on:
      - user-service-db
    ports:
      - "4000:4000"
    stdin_open: true
    tty: true

  user-service-db:
    image: postgres:16-alpine
    container_name: user-service-db
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=users_db
    ports:
      - "4001:5432"
    volumes:
      - user-service-db-data:/var/lib/postgresql/data
      - ../services/userService/src/database/init:/docker-entrypoint-initdb.d

  # Question Service
  question-service:
    build:
      context: ../services/questionService
      dockerfile: Dockerfile.dev
    container_name: question-service
    volumes:
      - ../services/questionService:/app
      - /app/node_modules
    environment:
      - NODE_ENV=development
      - PORT=4010
      - DATABASE_URL=postgresql://postgres:postgres@question-service-db:5432/questions_db
      - JWT_SECRET=4fa01f2f08d88986b2cc1e0c3d35ae63
    depends_on:
      - question-service-db
    ports:
      - "4010:4010"
    stdin_open: true
    tty: true

  question-service-db:
    image: postgres:16-alpine
    container_name: question-service-db
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=questions_db
    ports:
      - "4011:5432"
    volumes:
      - question-service-db-data:/var/lib/postgresql/data
      - ../services/questionService/src/database/init:/docker-entrypoint-initdb.d

volumes:
  user-service-db-data:
  question-service-db-data:
